<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Clinic Run — Select Area</title>
  <style>
    :root{--bg:#f2f5f9;--card:#ffffff;--muted:#6b7280;--blue:#0b69ff;--green:#10b981;--grey:#9ca3af}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:var(--bg);display:flex;flex-direction:column}
    .screen{max-width:480px;margin:0 auto;width:100%;padding:16px;box-sizing:border-box}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:8px 0}
    .big-card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    .choices{display:flex;gap:10px;justify-content:space-between;margin-top:12px}
    .btn{flex:1;padding:14px;border-radius:10px;border:0;font-weight:600;font-size:16px}
    .btn-choose{background:#eef2ff;color:var(--blue)}

    .parse-area{margin-top:14px}
    textarea{width:100%;min-height:120px;border-radius:10px;padding:12px;border:1px solid #e5e7eb;resize:vertical}
    .row{display:flex;gap:8px;margin-top:10px}
    .primary{background:var(--blue);color:white;padding:12px;border-radius:10px;border:0;flex:1}
    .secondary{background:white;border:1px solid #e5e7eb;padding:12px;border-radius:10px;color:var(--muted)}

    /* checklist */
    .list{margin-top:14px}
    .card{background:var(--card);padding:12px;border-radius:12px;margin-bottom:10px;display:flex;flex-direction:column;box-shadow:0 4px 10px rgba(2,6,23,0.04)}
    .card .top{display:flex;justify-content:space-between;align-items:center}
    .clinic-title{font-weight:700}
    .clinic-code{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .chip{padding:8px 10px;border-radius:8px;border:1px solid #e6e7eb;font-weight:600}
    .chip.blue{background:var(--blue);color:white}
    .chip.green{background:var(--green);color:white}
    .chip.grey{background:var(--grey);color:white}
    .small{font-size:13px;padding:6px 8px}
    .qtys{display:flex;gap:6px;flex-wrap:wrap}
    .qty{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px solid #e6e7eb;font-weight:700}
    .qty.selected{background:#111827;color:white}
    .done{background:#d1fae5;color:#065f46;padding:8px;border-radius:8px;border:0}
    .undo{background:#fff3cd;color:#7c2d12;padding:8px;border-radius:8px;border:0}

    footer{position:sticky;bottom:0;padding:12px;background:linear-gradient(0deg,rgba(242,245,249,1),rgba(242,245,249,0));}
    .progress-wrap{display:flex;align-items:center;gap:10px}
    .progress{background:#e6eefb;height:12px;border-radius:10px;flex:1;overflow:hidden}
    .progress > i{background:var(--blue);display:block;height:100%;width:0%}
    .endtrip{margin-top:10px;background:#111827;color:white;padding:12px;border-radius:10px;border:0;width:100%}

    .add-top{display:flex;gap:8px;margin-bottom:8px}
    .add-top input{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e7eb}
    .link{font-size:13px;color:var(--blue);text-decoration:underline;cursor:pointer}

    @media(min-width:520px){body{background:#fff} .screen{box-shadow:0 6px 20px rgba(2,6,23,0.06);border-radius:14px;margin-top:20px}}
  </style>
</head>
<body>
  <div class="screen" id="app">
    <div id="choose-screen" class="big-card">
      <h1>Select area to start</h1>
      <div class="choices">
        <button class="btn btn-choose" data-area="Surrey">Surrey</button>
        <button class="btn btn-choose" data-area="Merton">Merton</button>
        <button class="btn btn-choose" data-area="Cover">Cover</button>
      </div>
      <p style="margin-top:12px;color:var(--muted)">Choose one to continue — this only sets a label for the run.</p>
    </div>

    <div id="input-screen" class="big-card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1 id="area-label">Run</h1>
        <div class="link" id="back-to-choose">Change</div>
      </div>
      <div class="parse-area">
        <textarea id="raw-input" placeholder="Paste the raw text from your notes here..."></textarea>
        <div class="row">
          <button id="parse-btn" class="primary">Parse</button>
          <button id="clear-btn" class="secondary">Clear</button>
        </div>
      </div>
    </div>

    <div id="list-screen" style="display:none">
      <div class="big-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h1>Checklist</h1>
          <div style="font-size:13px;color:var(--muted)" id="run-info">Area</div>
        </div>

        <div class="add-top">
          <input id="add-code" placeholder="Add clinic code (e.g. WL3A) or name" />
          <button id="add-btn" class="chip">Add</button>
        </div>

        <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center">
          <div style="flex:1;background:#fff;padding:8px;border-radius:8px;border:1px solid #e6e7eb">Parsed list</div>
          <div style="font-size:13px;color:var(--muted)">Saved: <span id="saved-ind">—</span></div>
        </div>

        <div class="list" id="checklist"></div>

      </div>

      <footer>
        <div class="progress-wrap">
          <div style="font-size:13px;color:var(--muted)">Progress</div>
          <div class="progress"><i id="progress-bar"></i></div>
          <div style="font-weight:700" id="progress-text">0%</div>
        </div>
        <button id="endtrip" class="endtrip">End Trip</button>
      </footer>
    </div>
  </div>

  <script>
    // ********** CONFIG: MASTER SEQUENCE & DATA **********
    // IMPORTANT: Replace addresses and INSTRUCTIONS below with your real data.
    const MASTER = [
      {code:'Z2K',name:'Blue Cross Vets Merton', address:'88–92 Merton High St, Merton, SW19 1BD'},
      {code:'7FO17',name:'Wimbledon Veterinary Surgery', address:'170–172 Merton Road, Wimbledon, SW19 1EG'},
      {code:'7KY13',name:'Kydd & Kydd (Medivet Wimbledon)', address:'1–3 Leopold Rd, Wimbledon, SW19 7BB'},
      {code:'TH1S',name:'The Corner Veterinary Clinic', address:'1 Stayton Road, Sutton, SM1 1QY'},
      {code:'PR11',name:'Priory Vet Surgeons Ltd (Tadworth)', address:'Northlodge, 11 High St, Tadworth, KT20 5SD'},
      {code:'KGVS',name:'Kriek & Gibson Vet Surgery', address:'38 Brighton Rd, Banstead, Surrey, SM7 1BT'},
      {code:'WL3A',name:'DNA Grp – Winton Lodge Epsom', address:'36 Ashley Road, Epsom, KT18 5BH'},
      {code:'HEWP',name:'Voo Vet Group – Worcester Park', address:'5 The Parade, Vale Road, Worcester Park, KT4 7EE'},
      {code:'WICO',name:'Medivet Epsom Pound', address:'Court Lodge, Pound Lane, Epsom, KT19 8SB'},
      {code:'ARVS',name:'CVS Avenue Road Vet Surgeons', address:'Avenue Road, Wallington, Surrey, SM6 9QF'},
      {code:'PKS',name:'Parkside Vet Surgery', address:'61 Ruskin Rd, Carshalton, SM5 3DD'},
      {code:'OR1M',name:'Optivet London (South)', address:'Inside Pet Vet, 145 Morden Rd, Mitcham, CR4 4DB'},
      {code:'MIUG',name:'Mitcham Vet Clinic', address:'4 Upper Green East, Mitcham, CR4 2PA'},
      {code:'TO5L',name:'DNA Grp – Tooting', address:'5 London Road, SW17 9JR'},
      {code:'7AN67',name:'Animal Choice', address:'67 Upper Tooting Park, Tooting, SW17 7SU'},
      {code:'VO3B',name:'Voo Vets – Balham', address:'31 Bedford Rd, Balham, SW12 9EY'},
      {code:'7ST10',name:'Streatham Hill Vet Surgery', address:'101 Sternhold Ave, Streatham Hill, SW2 4PF'},
      {code:'HY64',name:'Voo Vets – Battersea', address:'644a Wandsworth Road, London, SW8 3JW'},
      {code:'7AL85',name:'All Creatures Vet Surgery', address:'85 Lavender Hill, Battersea, SW11 5QL'},
      {code:'BA4B',name:'Battersea Dogs & Cats Home', address:'4 Battersea Park Road, London, SW8 4AA'},
      {code:'7EL55',name:'Elizabeth Street Vet Clinic', address:'55 Elizabeth St, London, SW1W 9PP'},
      {code:'Z1K',name:'Blue Cross Animal Hospital (Victoria)', address:'Shephard House, 1–5 Hugh St, Victoria, SW1V 1QQ'},
      {code:'VBR',name:'Virtue Vets – Chelsea', address:'295–297 Brompton Rd, London, SW3 2DY'},
      {code:'7BR96',name:'Brompton Vets', address:'90 Fulham Road, London, SW3 6HR'},
      {code:'CFU',name:'Creature Comforts – Chelsea', address:'281 Fulham Road, Chelsea, SW10 9PZ'},
      {code:'VBO',name:'Virtue Vets – Chelsea The Boltons', address:'351 Fulham Road, Chelsea, SW10 9TW'},
      {code:'CH36',name:'Waggintails – Chelsea Vet Clinic', address:'364 Fulham Rd, Chelsea, SW10 9UU'},
      {code:'7AB85',name:'Abingdon Vet Surgery', address:'85 Earls Court Road, London, W8 6EF'},
      {code:'7ADAD',name:'The Holland Park Vet Clinic', address:'7 Addison Ave, Holland Park, London, W11 4QS'},
      {code:'CCN',name:'Creature Comforts – Notting Hill', address:'241 Westbourne Grove, Notting Hill, W11 2SE'},
      {code:'VIN',name:'Virtue Vets – Notting Hill', address:'20 Chepstow Corner, Chepstow Place, Notting Hill, W2 4XE'},
      {code:'CCS',name:'Creature Comforts – St Johns Wood', address:'9–11 St Johns Wood High St, NW8 7NG'},
      {code:'VVM',name:'Virtue Vet – Marylebone', address:'6 Nottingham Street, Marylebone, W1U 5EJ'},
      {code:'Z4K',name:'Blue Cross Animal Hospital (Hammersmith)', address:'Argyle Place, Hammersmith, W6 0RQ'},
      {code:'CPU',name:'Creature Comforts – Putney', address:'212 Putney Bridge Rd, SW15 2NA'},
      {code:'7DA8B',name:'Voo Vet Group – Wandsworth', address:'8 Barmouth Road, London, SW18 2DN'},
      {code:'SC3E',name:'Scourfield Vet Services', address:'49 Heythorp Street, London, SW18 5BS'},
      {code:'IS1M',name:'Islander Vets', address:'129 Manor Drive North, New Malden, KT3 5PD'},
    ];

    // Final drop-off always appended
    const FINAL = {code:'DROP',name:'Orchard Business Park, Forsyth Rd, Woking GU21 5SB',address:'Orchard Business Park, Forsyth Rd, Woking GU21 5SB'};

    // INSTRUCTIONS placeholder. Replace the values below with the exact texts you have (CFU, CPU, TO5L, VBO, CCN, CCS, VVM, SC3E)
    const INSTRUCTIONS = {
      CFU: 'Unlock door with square headed key. Remove key. Unlock door magnet with pin code 0725. Disarm alarm with code 0725 and tick. Pick up package from reception desk. If no package, take a photograph. Arm alarm 0725 and tick. Press magnet release to open door. Lock door with key.',
      CPU: 'Box is at the back on a side road (Deodar Road), alleyway all the way at the end of alley.',
      TO5L: 'Open key safe with code 7821. Open door with key from safe. Sample box behind the door. Lock door with key from safe. Put key back into safe and change code.',
      VBO: 'Open gate with padlock key. Walk all the way to the back. Box is on the left side. Lock gate with padlock key.',
      CCN: 'Open door with large key. Enter code 1216 to unlock magnet. Enter code 2513 to disarm alarm. Take sample. Arm alarm 2513. Lock door with large key.',
      CCS: 'Entrance is by side road with gate. Code to enter gate: 9876. Sample is by tiny alleyway after few doors on the right. Code to exit gate: 9876.',
      VVM: 'Padlock to go down 02024. Padlock sometimes gets stuck; pull harder to unlock.',
      SC3E: 'Front garden of house at 49 Heythorp Street SW18 5BS. Sample is inside front garden shed. Padlock code 1910. Lock shed when finished.',
      OR1M: 'Box is located on the side of the car park where the recycling trolleys are. Drive straight when you turn into the road. Code to open the box: 936.'
    };

    // *********************** APP STATE & STORAGE ************************
    const STORAGE_KEY = 'clinicRun_v1';
    let state = {
      area: null,
      parsed: [], // {code,name,address,info,selected,quantity,done,added}
    };

    // Load saved state
    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        try{state = JSON.parse(raw)}catch(e){console.warn('load err',e)}
      }
    }
    function save(){
      state.savedAt = new Date().toISOString();
      localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
      document.getElementById('saved-ind').innerText = new Date(state.savedAt).toLocaleTimeString();
    }

    // UI refs
    const chooseScreen = document.getElementById('choose-screen');
    const inputScreen = document.getElementById('input-screen');
    const listScreen = document.getElementById('list-screen');
    const rawInput = document.getElementById('raw-input');
    const parseBtn = document.getElementById('parse-btn');
    const clearBtn = document.getElementById('clear-btn');
    const checklist = document.getElementById('checklist');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const areaLabel = document.getElementById('area-label');
    const runInfo = document.getElementById('run-info');

    document.getElementById('back-to-choose').addEventListener('click',()=>{show('choose')});

    // Choose area
    document.querySelectorAll('.btn-choose').forEach(b=>b.addEventListener('click',e=>{
      const a = e.target.dataset.area;
      state.area = a;
      areaLabel.innerText = a + ' — Paste & parse';
      show('input');
      save();
    }));

    // Parse logic
    parseBtn.addEventListener('click',()=>{
      const txt = rawInput.value || '';
      const codes = parseText(txt);
      buildList(codes);
      show('list');
      save();
    });
    clearBtn.addEventListener('click',()=>{rawInput.value='';});

    // Add manual code
    document.getElementById('add-btn').addEventListener('click',()=>{
      const v = document.getElementById('add-code').value.trim();
      if(!v) return;
      addManual(v);
      document.getElementById('add-code').value='';
      save();
    });

    // End trip
    document.getElementById('endtrip').addEventListener('click',()=>{
      const unfinished = state.parsed.filter(p=>!p.done).map(p=>p.code);
      if(unfinished.length===0){
        // clear and go back
        if(confirm('All clinics completed. End trip and clear data?')){
          localStorage.removeItem(STORAGE_KEY);
          state={area:null,parsed:[]};
          show('choose');
        }
      } else {
        const res = confirm('You still have unfinished clinics: ' + unfinished.join(', ') + '.\n\nEnd anyway?');
        if(res){localStorage.removeItem(STORAGE_KEY);state={area:null,parsed:[]};show('choose');}
      }
    });

    // Show screens
    function show(which){
      chooseScreen.style.display = which==='choose'?'block':'none';
      inputScreen.style.display = which==='input'?'block':'none';
      listScreen.style.display = which==='list'?'block':'none';
      if(which==='list') renderList();
    }

    // Parsing rules
    function parseText(text){
      // Remove lines containing TOTAL or total
      const lines = text.split(/\n+/).map(l=>l.trim()).filter(Boolean).filter(l=>!/\bTOTAL\b|\bTotal\b|\btotal\b/.test(l));
      const tokens = lines.join(' ').split(/[\s,;:\-]+/);
      const cleaned = tokens.map(t=>t.replace(/[^A-Za-z0-9]/g,'').toUpperCase()).filter(Boolean);

      // Remove days and pure numbers and route numbers (digits)
      const days = ['MON','TUE','WED','THU','FRI','SAT','SUN','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY','SUNDAY'];
      const filtered = cleaned.filter(t=>!(days.includes(t) || /^\d+$/.test(t)));

      // Keep only tokens that look like codes (2-6 chars alnum) or tokens matching known names
      const candidate = filtered.filter(t=>/^[A-Z0-9]{2,6}$/.test(t));

      // Deduplicate keeping order
      const seen = new Set();
      const uniq = candidate.filter(c=>{if(seen.has(c)) return false;seen.add(c);return true;});
      return uniq;
    }

    // Build parsed list into state with ordering
    function buildList(codes){
      const masterIndex = {};
      MASTER.forEach((m,i)=>masterIndex[m.code]=i);

      // Map to objects with any known name/address
      const objs = codes.map(code=>{
        const found = MASTER.find(m=>m.code===code);
        return {code, name: found?found.name:code, address: found?found.address:'', info: INSTRUCTIONS[code]||'', selected:null, quantity:null, done:false, added:false};
      });

      // Split into known and unknown
      const known = objs.filter(o=>masterIndex[o.code]!==undefined).sort((a,b)=>masterIndex[a.code]-masterIndex[b.code]);
      const unknown = objs.filter(o=>masterIndex[o.code]===undefined).sort((a,b)=>a.code.localeCompare(b.code));

      state.parsed = [...known,...unknown, {...FINAL, info:'', selected:null, quantity:null, done:false, added:false}];
      state.area = state.area || 'Run';
      renderList();
    }

    // Add manual clinic
    function addManual(input){
      const code = input.toUpperCase().replace(/[^A-Z0-9]/g,'');
      const found = MASTER.find(m=>m.code===code);
      const obj = {code:code||input,name:found?found.name:input,address:found?found.address:'',info:INSTRUCTIONS[code]||'',selected:null,quantity:null,done:false,added:true};
      // Add before final dropoff
      const withoutFinal = state.parsed.filter(p=>p.code!=='DROP');
      withoutFinal.push(obj);
      state.parsed = [...withoutFinal, state.parsed.find(p=>p.code==='DROP')];
      renderList();
    }

    // Render list
    function renderList(){
      checklist.innerHTML='';
      state.parsed.forEach((item,idx)=>{
        const card = document.createElement('div');card.className='card';
        const top = document.createElement('div');top.className='top';
        const title = document.createElement('div');
        title.innerHTML = '<div class="clinic-title">'+escapeHtml(item.name)+'</div><div class="clinic-code">'+item.code+'</div>';
        top.appendChild(title);
        const right = document.createElement('div');
        // GO button - open maps search
        const goBtn = document.createElement('button');goBtn.className='chip small';goBtn.innerText='GO';
        goBtn.addEventListener('click',()=>{openMaps(item);});
        right.appendChild(goBtn);
        // INFO button
        const infoBtn = document.createElement('button');infoBtn.className='chip small';infoBtn.innerText='INFO';
        infoBtn.addEventListener('click',()=>{alert((item.info && item.info.length>0)?item.info:(item.name+'\n\nNo additional instructions provided.'))});
        right.appendChild(infoBtn);
        top.appendChild(right);
        card.appendChild(top);

        // Controls - if final dropoff, only show Done button
        const controls = document.createElement('div');controls.className='controls';
        if(item.code==='DROP'){
          const doneBtn = document.createElement('button');
          doneBtn.className=item.done?'undo':'done';
          doneBtn.innerText=item.done?'Undo':'Done';
          doneBtn.addEventListener('click',()=>{item.done=!item.done;save();renderList();});
          controls.appendChild(doneBtn);
        } else {
          // AXIOM/FINN/NTC
          const ax = document.createElement('button');ax.className='chip blue';ax.innerText='AXIOM';
          const fi = document.createElement('button');fi.className='chip green';fi.innerText='FINN';
          const nt = document.createElement('button');nt.className='chip grey';nt.innerText='NTC';
          [ax,fi,nt].forEach(b=>{
            b.addEventListener('click',()=>{
              item.selected = b.innerText;
              if(item.selected==='NTC') item.quantity=null; // skip quantity
              save();renderList();
            });
          });
          // Highlight selected
          if(item.selected==='AXIOM') ax.style.outline='3px solid rgba(11,105,255,0.15)';
          if(item.selected==='FINN') fi.style.outline='3px solid rgba(16,185,129,0.12)';
          if(item.selected==='NTC') nt.style.outline='3px solid rgba(156,163,175,0.12)';
          controls.appendChild(ax);controls.appendChild(fi);controls.appendChild(nt);

          // Quantity selector
          const qtyWrap = document.createElement('div');qtyWrap.className='qtys';
          for(let i=1;i<=10;i++){
            const q = document.createElement('div');q.className='qty';q.innerText=i;
            if(item.quantity===i) q.classList.add('selected');
            q.addEventListener('click',()=>{item.quantity=i;save();renderList();});
            qtyWrap.appendChild(q);
          }
          const ice = document.createElement('div');ice.className='qty';ice.innerText='Ice Box';
          if(item.quantity==='Ice Box') ice.classList.add('selected');
          ice.addEventListener('click',()=>{item.quantity='Ice Box';save();renderList();});
          qtyWrap.appendChild(ice);

          controls.appendChild(qtyWrap);

          // Done/Undo
          const doneBtn = document.createElement('button');
          // Button validity: NTC may be done without quantity; AXIOM/FINN need quantity selected
          doneBtn.disabled = !(item.selected && (item.selected==='NTC' || item.quantity));
          doneBtn.className=item.done?'undo':'done';
          doneBtn.innerText=item.done?'Undo':'Done';
          doneBtn.addEventListener('click',()=>{
            if(!item.done){
              // Validate
              if(!item.selected){alert('Please select AXIOM, FINN or NTC');return}
              if(item.selected!=='NTC' && !item.quantity){alert('Please select quantity before marking Done');return}
            }
            item.done=!item.done;save();renderList();
          });
          controls.appendChild(doneBtn);
        }

        card.appendChild(controls);
        checklist.appendChild(card);
      });
      updateProgress();
    }

    function updateProgress(){
      const total = state.parsed.length;
      const done = state.parsed.filter(p=>p.done).length;
      const pct = total?Math.round((done/total)*100):0;
      progressBar.style.width = pct + '%';
      progressText.innerText = pct + '%';
      runInfo.innerText = (state.area||'Run') + ' — ' + done + '/' + total;
    }

    function openMaps(item){
      // Uses Google Maps search query — this will open in browser and may hand off to Maps app on mobile
      const q = encodeURIComponent((item.address && item.address.length>0)? item.address : item.name + ' ' + item.address);
      const url = 'https://www.google.com/maps/search/?api=1&query=' + q;
      window.open(url, '_blank');
    }

    // Helpers
    function escapeHtml(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

    // On load, try to restore
    load();
    if(state.parsed && state.parsed.length>0){
      // keep showing list
      show('list');
    } else if(state.area){
      areaLabel.innerText = state.area + ' — Paste & parse';
      show('input');
    } else {
      show('choose');
    }

    // Inform user where to replace instructions/addresses
    console.log('Clinic app loaded. To set precise addresses and INFO texts, edit the MASTER and INSTRUCTIONS objects in the top of the HTML file.');
  </script>
</body>
</html>
