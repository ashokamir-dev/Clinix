<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Clinic Run — Select Area</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root{--bg:#f2f5f9;--card:#ffffff;--muted:#6b7280;--blue:#0b69ff;--green:#10b981;--grey:#9ca3af}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:var(--bg);display:flex;flex-direction:column}
    .screen{max-width:480px;margin:0 auto;width:100%;padding:16px;box-sizing:border-box}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:8px 0}
    .big-card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    .choices{display:flex;gap:10px;justify-content:space-between;margin-top:12px}
    .btn{flex:1;padding:14px;border-radius:10px;border:0;font-weight:600;font-size:16px}
    .btn-choose{background:#eef2ff;color:var(--blue)}
    .parse-area{margin-top:14px}
    textarea{width:100%;min-height:120px;border-radius:10px;padding:12px;border:1px solid #e5e7eb;resize:vertical}
    .row{display:flex;gap:8px;margin-top:10px}
    .primary{background:var(--blue);color:white;padding:12px;border-radius:10px;border:0;flex:1}
    .secondary{background:white;border:1px solid #e5e7eb;padding:12px;border-radius:10px;color:var(--muted)}
    .list{margin-top:14px}
    .card{background:var(--card);padding:12px;border-radius:12px;margin-bottom:10px;display:flex;flex-direction:column;box-shadow:0 4px 10px rgba(2,6,23,0.04)}
    .card .top{display:flex;justify-content:space-between;align-items:center}
    .clinic-title{font-weight:700}
    .clinic-code{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .chip{padding:8px 10px;border-radius:8px;border:1px solid #e6e7eb;font-weight:600}
    .chip.blue{background:var(--blue);color:white}
    .chip.green{background:var(--green);color:white}
    .chip.grey{background:var(--grey);color:white}
    .small{font-size:13px;padding:6px 8px}
    .qtys{display:flex;gap:6px;flex-wrap:wrap}
    .qty{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px solid #e6e7eb;font-weight:700}
    .qty.selected{background:#111827;color:white}
    .done{background:#d1fae5;color:#065f46;padding:8px;border-radius:8px;border:0}
    .undo{background:#fff3cd;color:#7c2d12;padding:8px;border-radius:8px;border:0}
    footer{position:sticky;bottom:0;padding:12px;background:linear-gradient(0deg,rgba(242,245,249,1),rgba(242,245,249,0));}
    .progress-wrap{display:flex;align-items:center;gap:10px}
    .progress{background:#e6eefb;height:12px;border-radius:10px;flex:1;overflow:hidden}
    .progress > i{background:var(--blue);display:block;height:100%;width:0%}
    .endtrip{margin-top:10px;background:#111827;color:white;padding:12px;border-radius:10px;border:0;width:100%}
    .add-top{display:flex;gap:8px;margin-bottom:8px}
    .add-top input{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e7eb}
    .link{font-size:13px;color:var(--blue);text-decoration:underline;cursor:pointer}
    #login-screen{max-width:480px;margin:20px auto}
    @media(min-width:520px){body{background:#fff} .screen{box-shadow:0 6px 20px rgba(2,6,23,0.06);border-radius:14px;margin-top:20px}}
  </style>
</head>

<body>
  <!-- LOGIN SCREEN (shown before the app if not logged in) -->
  <div id="login-screen" class="big-card" style="display:none;max-width:480px;margin:20px auto">
    <h1>Clinix Login</h1>
    <input id="login-username" placeholder="Username" style="width:100%;padding:12px;margin-top:10px;border-radius:10px;border:1px solid #ccc"/>
    <input id="login-password" placeholder="Password" type="password" style="width:100%;padding:12px;margin-top:10px;border-radius:10px;border:1px solid #ccc"/>
    <button id="login-btn" class="primary" style="margin-top:15px;width:100%">Login</button>
    <div id="login-error" style="color:red;margin-top:10px;display:none">Invalid username or password</div>
  </div>

  <!-- MAIN APP (hidden until login) -->
  <div class="screen" id="app" style="display:none">

    <!-- CHOOSE -->
    <div id="choose-screen" class="big-card">
      <h1>Select area to start</h1>
      <div class="choices">
        <button class="btn btn-choose" data-area="Surrey">Surrey</button>
        <button class="btn btn-choose" data-area="Merton">Merton</button>
        <button class="btn btn-choose" data-area="Cover">Cover</button>
      </div>
      <p style="margin-top:12px;color:var(--muted)">Choose one to continue — this only sets a label for the run.</p>
    </div>

    <!-- COVER START SCREEN -->
    <div id="cover-start-screen" class="big-card" style="display:none">
      <h1>Start Location</h1>
      <button class="primary" id="cover-gps-btn">Use My GPS Location</button>
      <div style="text-align:center;margin:10px 0;font-size:13px;color:var(--muted)">— OR —</div>
      <input id="cover-address-input" placeholder="Enter starting address (e.g., Streatham, Wimbledon)" style="width:100%;padding:12px;border-radius:10px;border:1px solid #e5e7eb" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="primary" id="cover-address-btn" style="flex:1">Use This Address</button>
        <button class="secondary" id="cover-back-btn">Back</button>
      </div>
    </div>

    <!-- INPUT SCREEN -->
    <div id="input-screen" class="big-card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1 id="area-label">Run</h1>
        <div class="link" id="back-to-choose">Change</div>
      </div>
      <div class="parse-area">
        <textarea id="raw-input" placeholder="Paste the raw text from your notes here..."></textarea>
        <div class="row">
          <button id="parse-btn" class="primary">Parse</button>
          <button id="clear-btn" class="secondary">Clear</button>
        </div>
      </div>
    </div>

    <!-- LIST SCREEN -->
    <div id="list-screen" style="display:none">
      <div class="big-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h1>Checklist</h1>
          <div style="font-size:13px;color:var(--muted)" id="run-info">Area</div>
        </div>
        <!-- Change navigation app -->
        <div style="text-align:right;margin:5px 0;">
          <span id="change-nav" style="font-size:13px;color:#0b69ff;cursor:pointer;text-decoration:underline;">
            Change Navigation App
          </span>
        </div>

        <!-- Logout -->
        <div style="text-align:right;margin-bottom:10px">
          <span id="logout-btn" style="font-size:13px;color:#dc2626;cursor:pointer">Logout</span>
        </div>

        <div class="add-top">
          <input id="add-code" placeholder="Add clinic code or name" />
          <button id="add-btn" class="chip">Add</button>
        </div>

        <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center">
          <div style="flex:1;background:#fff;padding:8px;border-radius:8px;border:1px solid #e6e7eb">Parsed list</div>
          <div style="font-size:13px;color:var(--muted)">Saved: <span id="saved-ind">—</span></div>
        </div>

        <div class="list" id="checklist"></div>
      </div>

      <footer>
        <div class="progress-wrap">
          <div style="font-size:13px;color:var(--muted)">Progress</div>
          <div class="progress"><i id="progress-bar"></i></div>
          <div style="font-weight:700" id="progress-text">0%</div>
        </div>
      </footer>
    </div>
  </div>

  <script>
    // ===============================
    // SIMPLE USER AUTH (hardcoded)
    // ===============================
    const USERS = {
      "ashok":   "welcome25!",
      "ajant": "happy26!",
      "dhanu":   "dhanu25!"
    };
    let ACTIVE_USER = null;

    // Navigation app preference per user
    function navKey() {
      return ACTIVE_USER ? `nav_app_${ACTIVE_USER}` : `nav_app_temp`;
    }

    function getNavApp() {
      return localStorage.getItem(navKey()) || null;
    }

    function setNavApp(app) {
      localStorage.setItem(navKey(), app);
    }

    // Show prompt to pick app
    function chooseNavApp() {
      return new Promise(resolve => {
        const app = prompt(
          "Choose navigation app:\n1 = Google Maps\n2 = Apple Maps\n3 = Waze",
          "1"
        );

        let chosen = null;

        if (app === "1") chosen = "google";
        if (app === "2") chosen = "apple";
        if (app === "3") chosen = "waze";

        if (!chosen) chosen = "google"; // default fallback

        setNavApp(chosen);
        resolve(chosen);
      });
    }
    document.getElementById('change-nav').addEventListener('click', async () => {
      await chooseNavApp();
      alert("Navigation app updated for this session.");
    });

    // ===============================
    // MASTER LISTS (Merton + Surrey)
    // ===============================
    const MASTER_MERTON = [
      {code:'Z2K',name:'Blue Cross Vets Merton',address:'88-92 Merton High St, Merton, SW19 1BD'},
      {code:'7FO17',name:'Wimbledon Veterinary Surgery',address:'170-172 Merton Road, Wimbledon, SW19 1EG'},
      {code:'7KY13',name:'Kydd & Kydd (Medivet Wimbledon)',address:'1-3 Leopold Rd, Wimbledon, SW19 7BB'},
      {code:'TH1S',name:'The Corner Veterinary Clinic',address:'1 Stayton Road, Sutton, SM1 1QY'},
      {code:'PR11',name:'Priory Vet Surgeons Ltd (Tadworth)',address:'Northlodge, 11 High St, Tadworth, KT20 5SD'},
      {code:'KGVS',name:'Kriek & Gibson Vet Surgery',address:'38 Brighton Rd, Banstead, Surrey, SM7 1BT'},
      {code:'WL3A',name:'DNA Grp,  Winton Lodge Epsom',address:'36 Ashley Road, Epsom, KT18 5BH'},
      {code:'HEWP',name:'Voo Vet Group, Worcester Park',address:'5 The Parade, Vale Road, Worcester Park, KT4 7EE'},
      {code:'WICO',name:'Medivet Epsom Pound',address:'Court Lodge, Pound Lane, Epsom, KT19 8SB'},
      {code:'ARVS',name:'CVS Avenue Road Vet Surgeons',address:'Avenue Road, Wallington, Surrey, SM6 9QF'},
      {code:'PKS',name:'Parkside Vet Surgery',address:'61 Ruskin Rd, Carshalton, SM5 3DD'},
      {code:'OR1M',name:'Optivet London (South)',address:'Inside Pet Vet, 145 Morden Rd, Mitcham, CR4 4DB'},
      {code:'MIUG',name:'Mitcham Vet Clinic',address:'4 Upper Green East, Mitcham, CR4 2PA'},
      {code:'TO5L',name:'DNA Grp, Tooting',address:'5 London Road, SW17 9JR'},
      {code:'AV4L',name:'Advanced Vert Care Streatham',address:'49 Leigham Court Road, Streatham, SW16 2NF'},
      {code:'7AN67',name:'Animal Choice',address:'67 Upper Tooting Park, Tooting, SW17 7SU'},
      {code:'VO3B',name:'Voo Vets, Balham',address:'31 Bedford Rd, Balham, SW12 9EY'},
      {code:'7ST10',name:'Streatham Hill Vet Surgery',address:'101 Sternhold Ave, Streatham Hill, SW2 4PF'},
      {code:'HY64',name:'Voo Vets, Battersea',address:'644a Wandsworth Road, London, SW8 3JW'},
      {code:'7AL85',name:'All Creatures Vet Surgery',address:'85 Lavender Hill, Battersea, SW11 5QL'},
      {code:'BA4B',name:'Battersea Dogs & Cats Home',address:'4 Battersea Park Road, London, SW8 4AA'},
      {code:'7EL55',name:'Elizabeth Street Vet Clinic',address:'55 Elizabeth St, London, SW1W 9PP'},
      {code:'Z1K',name:'Blue Cross Animal Hospital (Victoria)',address:'Shephard House, 1-5 Hugh St, Victoria, SW1V 1QQ'},
      {code:'VBR',name:'Virtue Vets, Chelsea',address:'295-297 Brompton Rd, London, SW3 2DY'},
      {code:'7BR96',name:'Brompton Vets',address:'90 Fulham Road, London, SW3 6HR'},
      {code:'CFU',name:'Creature Comforts,  Chelsea',address:'281 Fulham Road, Chelsea, SW10 9PZ'},
      {code:'VBO',name:'Virtue Vets,  Chelsea The Boltons',address:'351 Fulham Road, Chelsea, SW10 9TW'},
      {code:'CH36',name:'Waggintails,  Chelsea Vet Clinic',address:'364 Fulham Rd, Chelsea, SW10 9UU'},
      {code:'7AB85',name:'Abingdon Vet Surgery',address:'85 Earls Court Road, London, W8 6EF'},
      {code:'7ADAD',name:'The Holland Park Vet Clinic',address:'7 Addison Ave, Holland Park, London, W11 4QS'},
      {code:'CCN',name:'Creature Comforts,  Notting Hill',address:'241 Westbourne Grove, Notting Hill, W11 2SE'},
      {code:'VIN',name:'Virtue Vets,  Notting Hill',address:'20 Chepstow Corner, Chepstow Place, Notting Hill, W2 4XE'},
      {code:'CCS',name:'Creature Comforts,  St Johns Wood',address:'9-11 St Johns Wood High St, NW8 7NG'},
      {code:'VVM',name:'Virtue Vets, Marylebone',address:'6 Nottingham Street, Marylebone, W1U 5EJ'},
      {code:'Z4K',name:'Blue Cross Animal Hospital (Hammersmith)',address:'Argyle Place, Hammersmith, W6 0RQ'},
      {code:'CPU',name:'Creature Comforts, Putney',address:'212 Putney Bridge Rd, SW15 2NA'},
      {code:'7DA8B',name:'Voo Vet Group, Wandsworth',address:'8 Barmouth Road, London, SW18 2DN'},
      {code:'IS1M' ,name:'Islander Vets, Morden Mannor',address:'129 Manor Dr N, New Malden, KT3 5PD'},
    ];

    // Final clinic for drop location
    const FINAL = { code: 'DROP', name: 'Orchard Business Park, Forsyth Rd, Woking GU21 5SB', address: 'Orchard Business Park, Forsyth Rd, Woking GU21 5SB' };

    // Instructions for some clinics
    const INSTRUCTIONS = {
      CFU: 'Unlock door with square headed key. Remove key. Unlock door magnet with pin code 0725. Disarm alarm with code 0725 and tick. Pick up package from reception desk. If no package, take a photograph. Arm alarm 0725 and tick. Press magnet release to open door. Lock door with key.',
      CPU: 'Box is at the back on a side road (Deodar Road), alleyway all the way at the end of alley.',
      TO5L: 'Open key safe with code 7821. Open door with key from safe. Sample box behind the door. Lock door with key from safe. Put key back into safe and change code.',
      VBO: 'Open gate with padlock key. Walk all the way to the back. Box is on the left side. Lock gate with padlock key.',
      CCN: 'Open door with large key. Enter code 1216 to unlock magnet. Enter code 2513 to disarm alarm. Take sample. Arm alarm 2513. Lock door with large key.',
      CCS: 'Entrance is by side road with gate. Code to enter gate: 9876. Sample is by tiny alleyway after few doors on the right. Code to exit gate: 9876.',
      VVM: 'Padlock to go down 02024. Padlock sometimes gets stuck; pull harder to unlock.',
      SC3E: 'Front garden of house at 49 Heythorp Street SW18 5BS. Sample is inside front garden shed. Padlock code 1910. Lock shed when finished.',
      OR1M: 'Box is located on the side of the car park where the recycling trolleys are. Drive straight when you turn into the road. Code to open the box: 936.',
      AV4L: 'No special instructions.'
    };

    // Coordinates for the clinics
    const CLINIC_COORDS = {
      Z2K: { lat: 51.409, lon: -0.177 },
      '7FO17': { lat: 51.4210, lon: -0.2083 },
      '7KY13': { lat: 51.424, lon: -0.205 },
      TH1S: { lat: 51.364, lon: -0.193 },
      PR11: { lat: 51.278, lon: -0.239 },
      KGVS: { lat: 51.311, lon: -0.187 },
      WL3A: { lat: 51.334, lon: -0.270 },
      HEWP: { lat: 51.364, lon: -0.216 },
      WICO: { lat: 51.334, lon: -0.268 },
      ARVS: { lat: 51.370, lon: -0.161 },
      PKS: { lat: 51.350, lon: -0.163 },
      OR1M: { lat: 51.403, lon: -0.169 },
      MIUG: { lat: 51.401, lon: -0.169 },
      TO5L: { lat: 51.428, lon: -0.164 },
      AV4L: { lat: 51.431, lon: -0.128 },
      '7AN67': { lat: 51.427, lon: -0.165 },
      VO3B: { lat: 51.442, lon: -0.152 },
      '7ST10': { lat: 51.433, lon: -0.116 },
      HY64: { lat: 51.475, lon: -0.156 },
      '7AL85': { lat: 51.472, lon: -0.159 },
      BA4B: { lat: 51.480, lon: -0.154 },
      '7EL55': { lat: 51.497, lon: -0.135 },
      Z1K: { lat: 51.495, lon: -0.141 },
      VBR: { lat: 51.496, lon: -0.162 },
      '7BR96': { lat: 51.492, lon: -0.190 },
      CFU: { lat: 51.488, lon: -0.162 },
      VBO: { lat: 51.488, lon: -0.162 },
      CH36: { lat: 51.487, lon: -0.163 },
      '7AB85': { lat: 51.494, lon: -0.192 },
      '7ADAD': { lat: 51.512, lon: -0.204 },
      CCN: { lat: 51.512, lon: -0.206 },
      VIN: { lat: 51.513, lon: -0.202 },
      CCS: { lat: 51.532, lon: -0.174 },
      VVM: { lat: 51.519, lon: -0.138 },
      Z4K: { lat: 51.492, lon: -0.227 },
      CPU: { lat: 51.463, lon: -0.2158 },
      '7DA8B': { lat: 51.444, lon: -0.174 },
      SC3E: { lat: 51.452, lon: -0.181 },
      IS1M: { lat: 51.396, lon: -0.252 }
    };

    // -------------------------
    // STATE & STORAGE
    // -------------------------
    let state = {area:null, parsed:[]};
    let coverStartPoint = null;
    function load() {
      const raw = localStorage.getItem(userStorageKey());
      if (raw) {
        try {
          state = JSON.parse(raw);
        } catch (e) {
          console.warn('load err', e);
        }
      }
    }

    function save() {
      state.savedAt = new Date().toISOString();
      localStorage.setItem(userStorageKey(), JSON.stringify(state));
      const el = document.getElementById('saved-ind');
      if (el) el.innerText = new Date(state.savedAt).toLocaleTimeString();
    }

    // ===============================
    // CLINIC ID VALIDATION
    // ===============================
    const validClinicIDs = [
      'Z2K', '7FO17', '7KY13', 'TH1S', 'PR11', 'KGVS', 'WL3A', 'HEWP', 'WICO', 'ARVS',
      'PKS', 'OR1M', 'MIUG', 'TO5L', 'AV4L', '7ST10', 'VO3B', '7AN67', 'HY64', '7AL85',
      'BA4B', '7EL55', 'Z1K', 'VBR', '7BR96', 'CFU', 'VBO', 'CH36', '7AB85', '7ADAD',
      'CCN', 'VIN', 'CCS', 'VVM', 'Z4K', 'CPU', '7DA8B', 'SC3E', 'IS1M'
    ];

    function addNewClinic() {
      const clinicID = document.getElementById('add-code').value.trim().toUpperCase();
      if (validClinicIDs.includes(clinicID)) {
        const clinic = MASTER_MERTON.find(item => item.code === clinicID);
        if (clinic) {
          state.parsed.push({
            code: clinic.code,
            name: clinic.name,
            address: clinic.address,
            selected: null,
            quantity: null,
            icebox: false,
            done: false
          });
          state.parsed.sort((a, b) => {
            return validClinicIDs.indexOf(a.code) - validClinicIDs.indexOf(b.code);
          });
          renderList();
        }
      } else {
        alert('Invalid clinic ID. Please enter a valid ID.');
      }
    }

    document.getElementById('add-btn').addEventListener('click', addNewClinic);

    function renderList() {
      const checklist = document.getElementById('checklist');
      checklist.innerHTML = '';

      state.parsed.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="top">
            <div class="clinic-title">
              <span class="surgery-name">${item.name}</span>
              <span class="info-link" onclick="showInfo('${item.name}')">INFO</span>
            </div>
            <div class="go-btn">
              <button class="chip green">GO</button>
            </div>
          </div>
        `;
        checklist.appendChild(card);
      });
    }

    function showInfo(name) {
      alert(`Info for ${name}`);
    }

    function logout() {
      if (confirm("Are you sure you want to log out? All progress will be cleared.")) {
        localStorage.removeItem('active_clinix_user');
        state = { area: null, parsed: [] };
        window.location.href = './login.html';
      }
    }

    // Add event listener for logout
    document.getElementById('logout-btn').addEventListener('click', logout);

    // ===============================
    // INITIAL LOAD / SHOW / LOGIN
    // ===============================
    function show(which) {
      document.getElementById('login-screen').style.display = 'none';
      chooseScreen.style.display = which === 'choose' ? 'block' : 'none';
      coverStartScreen.style.display = which === 'cover-start' ? 'block' : 'none';
      inputScreen.style.display = which === 'input' ? 'block' : 'none';
      listScreen.style.display = which === 'list' ? 'block' : 'none';

      if (which === 'list') renderList();
    }

    function showLogin() {
      document.getElementById('login-screen').style.display = 'block';
      document.getElementById('app').style.display = 'none';
    }

    function showApp() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    }

    // Auto-login if saved
    const savedUser = localStorage.getItem('active_clinix_user');
    if (savedUser && USERS[savedUser]) {
      ACTIVE_USER = savedUser;
      load();
      showApp();
      if (state.parsed && state.parsed.length > 0) show('list');
      else if (state.area) { areaLabel.innerText = state.area + ' — Paste & parse'; show('input'); }
      else show('choose');
    } else {
      showLogin();
    }

    // Login button
    document.getElementById('login-btn').addEventListener('click', () => {
      const user = document.getElementById('login-username').value.trim();
      const pass = document.getElementById('login-password').value;
      if (USERS[user] && USERS[user] === pass) {
        ACTIVE_USER = user;
        localStorage.setItem('active_clinix_user', user);
        load();
        showApp();
        if (state.parsed && state.parsed.length > 0) show('list');
        else if (state.area) { areaLabel.innerText = state.area + ' — Paste & parse'; show('input'); }
        else show('choose');
      } else {
        document.getElementById('login-error').style.display = 'block';
      }
    });

    // Register service worker
    if ('serviceWorker' in navigator) {
      try { navigator.serviceWorker.register('service-worker.js'); } catch (e) { console.warn('SW failed', e); }
    }
  </script>
</body>
</html>
